    pipeline {
        agent any
        environment { 
            GIT_REPO = 'https://github.com/YongSinh/agritech-iot.git'
            APP_ENV= 'uat'
            APP_VERSION= '1.0.0'
        }
        parameters {
            choice(name: 'BRANCH', choices: ['main', 'uat', 'dev'], description: 'Please select branch')
            choice(name: 'PROJECT', choices: [
                'agritech-iot', 
                'logs-service', 
                'api-gateway'
            ], description: 'Please select project')
            // Add a parameter for the cron schedule
        }
        tools {
            jdk 'graalvm-jdk-21'
            maven 'Maven 3.9.5' // Make sure Maven is set up in Jenkins
        }
        stages {
            stage('Clean Workspace') {
                steps {
                    cleanWs() // Clean the workspace before starting the build
                }
            }
            stage('Checkout Code') {
                steps {
                    script {
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: "*/${params.BRANCH}"]],
                            extensions: [
                                [$class: 'SparseCheckoutPaths', sparseCheckoutPaths: [[path: "${params.PROJECT}"]]]
                            ],
                            userRemoteConfigs: [[
                                url: "${env.GIT_REPO}",
                                credentialsId: 'jenkins_ci'
                            ]]
                        ])
                    }
                }
            }
            stage('Build Project') {
                steps {
                    script {
                        def projectDir = "${params.PROJECT}"
                        def pomFile = "${projectDir}/pom.xml"
                        
                        if (!fileExists(pomFile)) {
                            error "POM file not found at '${pomFile}'. Please check the repository structure."
                        }
                        
                        // Capture Maven output
                        def mavenOutput = sh(script: """
                            cd ${projectDir}
                            echo "Building project: ${projectDir}"
                            mvn -f pom.xml clean package spring-boot:build-image -DskipTests=true
                        """, returnStdout: true).trim()

                        // Extract Docker image name from Maven output
                        def imageName = (mavenOutput =~ /Successfully built image '([^']+)'/)[0][1]
                        echo "Built Docker image: ${imageName}"

                        // Store the image name in an environment variable for later use
                        env.DOCKER_IMAGE = imageName
                    }
                }
            }
        }
       post {
            success {
                script {
                    echo "✅ Build completed successfully for project: ${params.PROJECT}"
                }
            }
            failure {
                script {
                    echo "❌ Build failed for project: ${params.PROJECT}. Check the logs for details."
                }
            }
        }
    }
